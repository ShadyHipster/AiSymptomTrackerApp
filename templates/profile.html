{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-user-edit"></i> User Profile</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Username:</strong> {{ user[1] }}</p>
                        <p><strong>Email:</strong> {{ user[3] }}</p>
                        <p><strong>Age:</strong> {{ user[4] if user[4] else 'Not specified' }}</p>
                        <p><strong>Gender:</strong> {{ user[5].title() if user[5] else 'Not specified' }}</p>
                        <p><strong>Member since:</strong> {{ user[6][:10] if user[6] else 'N/A' }}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-lightbulb"></i> Profile Tips</h6>
                            <ul class="mb-0 small">
                                <li>Keep your medical history updated for better AI diagnoses</li>
                                <li>Be specific about condition dates and severity</li>
                                <li>Include any allergies or chronic conditions</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add Medical Condition</h5>
            </div>
            <div class="card-body">
                <form id="medicalHistoryForm">
                    <div class="mb-3">
                        <label for="condition" class="form-label">Condition/Diagnosis</label>
                        <input type="text" class="form-control" id="condition" required
                               placeholder="e.g., Diabetes, Hypertension, Asthma">
                    </div>
                    <div class="mb-3">
                        <label for="diagnosis_date" class="form-label">Diagnosis Date</label>
                        <input type="date" class="form-control" id="diagnosis_date">
                    </div>
                    <div class="mb-3">
                        <label for="severity" class="form-label">Severity</label>
                        <select class="form-control" id="severity">
                            <option value="">Select Severity</option>
                            <option value="mild">Mild</option>
                            <option value="moderate">Moderate</option>
                            <option value="severe">Severe</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" rows="3" 
                                  placeholder="Additional information, medications, etc."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Condition
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-medical-alt"></i> Medical History</h5>
            </div>
            <div class="card-body">
                <div id="medicalHistoryList">
                    {% if medical_history %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Condition</th>
                                    <th>Diagnosis Date</th>
                                    <th>Severity</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for condition in medical_history %}
                                <tr>
                                    <td><strong>{{ condition[2] }}</strong></td>
                                    <td>{{ condition[3] if condition[3] else 'Not specified' }}</td>
                                    <td>
                                        {% if condition[4] %}
                                        <span class="badge 
                                            {% if condition[4] == 'mild' %}bg-success
                                            {% elif condition[4] == 'moderate' %}bg-warning
                                            {% elif condition[4] == 'severe' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ condition[4].title() }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if condition[5] %}
                                        <div class="text-truncate" style="max-width: 200px;" title="{{ condition[5] }}">
                                            {{ condition[5] }}
                                        </div>
                                        {% else %}
                                        <span class="text-muted">No notes</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info" onclick="viewCondition({{ condition[0] }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-medical fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No medical history recorded</h5>
                        <p class="text-muted">Add your medical conditions to get more accurate AI diagnoses.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for viewing condition details -->
<div class="modal fade" id="conditionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Medical Condition Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="conditionModalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('medicalHistoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        condition: document.getElementById('condition').value,
        diagnosis_date: document.getElementById('diagnosis_date').value,
        severity: document.getElementById('severity').value,
        notes: document.getElementById('notes').value
    };
    
    try {
        const response = await fetch('/profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload the page to show the new condition
            window.location.reload();
        } else {
            alert(data.error || 'Failed to add medical condition');
        }
    } catch (error) {
        alert('Failed to add medical condition: ' + error.message);
    }
});

function viewCondition(conditionId) {
    const medicalHistory = {{ medical_history|tojson if medical_history else '[]' }};
    const condition = medicalHistory.find(item => item[0] === conditionId);
    
    if (!condition) return;
    
    document.getElementById('conditionModalContent').innerHTML = `
        <div class="mb-3">
            <h6>Condition:</h6>
            <p class="fs-5 fw-bold">${condition[2]}</p>
        </div>
        
        <div class="mb-3">
            <h6>Diagnosis Date:</h6>
            <p>${condition[3] || 'Not specified'}</p>
        </div>
        
        <div class="mb-3">
            <h6>Severity:</h6>
            ${condition[4] ? `<span class="badge 
                ${condition[4] === 'mild' ? 'bg-success' : 
                  condition[4] === 'moderate' ? 'bg-warning' : 
                  condition[4] === 'severe' ? 'bg-danger' : 'bg-secondary'}">${condition[4].charAt(0).toUpperCase() + condition[4].slice(1)}</span>` : 
                '<span class="text-muted">Not specified</span>'}
        </div>
        
        <div class="mb-3">
            <h6>Notes:</h6>
            <p class="border p-2 bg-light">${condition[5] || 'No additional notes'}</p>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('conditionModal')).show();
}
</script>
{% endblock %}