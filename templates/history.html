{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-history"></i> Symptom History</h4>
            </div>
            <div class="card-body">
                {% if symptom_history %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symptoms</th>
                                <th>AI Diagnosis</th>
                                <th>Triage Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in symptom_history %}
                            <tr>
                                <td>{{ log[6][:10] if log[6] else 'N/A' }}</td>
                                <td>
                                    <div class="text-truncate" style="max-width: 200px;" title="{{ log[2] }}">
                                        {{ log[2] }}
                                    </div>
                                </td>
                                <td>
                                    {% if log[3] %}
                                    <span class="badge bg-info me-1">AI Diagnosis</span>
                                    {% else %}
                                    <span class="text-muted">No diagnosis</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log[5] == 'emergency' %}
                                    <span class="badge bg-danger">Emergency</span>
                                    {% elif log[5] == 'doctor_visit' %}
                                    <span class="badge bg-warning">Doctor Visit</span>
                                    {% elif log[5] == 'home_care' %}
                                    <span class="badge bg-success">Home Care</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetails({{ log[0] }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clipboard fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No symptom history yet</h5>
                    <p class="text-muted">Start by describing your symptoms in the dashboard.</p>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Get Started</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-medical"></i> Medical History</h5>
            </div>
            <div class="card-body">
                {% if medical_history %}
                {% for condition in medical_history %}
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <h6 class="card-title mb-1">{{ condition[2] }}</h6>
                        {% if condition[3] %}
                        <small class="text-muted">Diagnosed: {{ condition[3] }}</small>
                        {% endif %}
                        {% if condition[4] %}
                        <div><span class="badge bg-secondary">{{ condition[4] }}</span></div>
                        {% endif %}
                        {% if condition[5] %}
                        <small class="text-muted">{{ condition[5] }}</small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">No medical history recorded.</p>
                {% endif %}
                <a href="{{ url_for('profile') }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus"></i> Add Condition
                </a>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h3 class="text-primary">{{ symptom_history|length }}</h3>
                        <small>Total Consultations</small>
                    </div>
                    <div class="col-6">
                        <h3 class="text-success">{{ medical_history|length }}</h3>
                        <small>Medical Conditions</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for viewing detailed symptom log -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Symptom Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function viewDetails(logId) {
    // Find the log entry
    const symptomHistory = {{ symptom_history|tojson }};
    const log = symptomHistory.find(item => item[0] === logId);
    
    if (!log) return;
    
    let diagnoses, recommendations;
    try {
        diagnoses = log[3] ? JSON.parse(log[3]) : [];
        recommendations = log[4] ? JSON.parse(log[4]) : [];
    } catch (e) {
        diagnoses = [];
        recommendations = [];
    }
    
    let triageClass = '';
    let triageText = '';
    
    switch(log[5]) {
        case 'emergency':
            triageClass = 'danger';
            triageText = 'Emergency - Seek Immediate Care';
            break;
        case 'doctor_visit':
            triageClass = 'warning';
            triageText = 'Doctor Visit Recommended';
            break;
        case 'home_care':
            triageClass = 'success';
            triageText = 'Home Care';
            break;
        default:
            triageClass = 'info';
            triageText = 'No Triage Level';
    }
    
    document.getElementById('modalContent').innerHTML = `
        <div class="mb-3">
            <h6>Date:</h6>
            <p>${log[6] ? log[6].split('T')[0] : 'N/A'}</p>
        </div>
        
        <div class="mb-3">
            <h6>Symptoms Described:</h6>
            <p class="border p-2 bg-light">${log[2]}</p>
        </div>
        
        <div class="alert alert-${triageClass} mb-3">
            <h6>Triage Level: ${triageText}</h6>
        </div>
        
        <div class="mb-3">
            <h6>Possible Diagnoses:</h6>
            <ul class="list-group list-group-flush">
                ${diagnoses.length > 0 ? diagnoses.map(diagnosis => `<li class="list-group-item">${diagnosis}</li>`).join('') : '<li class="list-group-item">No diagnoses available</li>'}
            </ul>
        </div>
        
        <div class="mb-3">
            <h6>AI Recommendations:</h6>
            <ul class="list-group list-group-flush">
                ${recommendations.length > 0 ? recommendations.map(rec => `<li class="list-group-item">${rec}</li>`).join('') : '<li class="list-group-item">No recommendations available</li>'}
            </ul>
        </div>
        
        <div class="alert alert-info">
            <small><i class="fas fa-info-circle"></i> This diagnosis was generated by AI and should not replace professional medical advice.</small>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}
</script>
{% endblock %}